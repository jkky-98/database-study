# 트랜잭션(TRANSACTION)

트랜잭션이란, **논리적으로 절대 쪼개질 수 없는 하나 이상의 데이터베이스 작업 묶음(Unit of Work)**을 의미한다.

트랜잭션은 우리에게 아주 강력한 약속을 제공한다. 바로 **'전부 아니면 전무(All or Nothing)'** 라는 원칙이다.

트랜잭션으로 묶인 작업들은 **모두 다 성공해야만** 그 결과를 실제 데이터베이스에 영구적으로 반영한다.

만약 작업 그룹 내에서 **단 하나의 작업이라도 실패**하면, 그전에 성공했던 모든 작업들을 **전부 없었던 일로 되돌려 버린다.**

1. 주문 테이블 INSERT 쿼리 = 주문 데이터 추가
2. 상품을 주문하였으므로 상품재고에서 상품 재고수량을 줄여야함.
3. 재고 테이블 UPDATE 쿼리 (주문내의 상품 수량만큼 재고 수량에서 빼기)

1.만 성공하고 2.는 실패한다면 데이터 상 주문은 성공했는데 재고에서 빠져나가지 않는 심각한 오류에 빠진다.
2.만 성공하고 1.는 실패한다면 주문도 안들어왔는데 재고가 빠져나가는 심각한 오류에 빠진다.

1,3은 항상 같이 성공하거나 같이 실패해야한다. 트랜잭션은 이러한 문제에서의 "묶음"기능을 제공한다.

## 커밋, 롤백

START TRANSACTION(혹은 BEGIN)으로 트랜잭션을 시작한다고 알릴 수 있다.

그 후 작성하는 모든 쿼리들은 하나의 묶음으로 처리된다.

묶음 처리가 끝나려면 ROLLBACK 혹은 COMMIT을 수행해야한다.

ROLLBACK은 그 사이의 모든 결과를 취소하는 것이고 COMMIT은 그 사이의 모든 결과를 수용하는 것이다.

```sql
-- 트랜잭션 시작 
START TRANSACTION;
-- 1번 작업: A고객 계좌에서 10,000원 출금
UPDATE accounts SET balance = balance - 10000 WHERE id = 1;
-- 2번 작업: B고객 계좌에 10,000원 입금
UPDATE accounts SET balance = balance + 10000 WHERE id = 2;
COMMIT;
```

### MYSQL의 autocommit

MYSQL은 기본적으로 autocommit 모드가 활성화되어 있다. 우리가 실행하는 모든 SQL문 하나하나를 각각의 트랜잭션으로 간주하는 것이다. 성공시 즉시 COMMIT한다.

만약 새로운 묶음을 시작하고 싶다면 START TRANSACTION을 수행하고 실행하는 것이다.

# ACID

트랜잭션이 신뢰성을 갖추도록 반드시 지켜야 할 4가지 속성을 묶어 ACID라는 약어로 부른다.
즉 트랜잭션은 설명할 네 가지 속성을 반드시 만족한다는 것이다.

## A - Atomicity(원자성)
트랜잭션 안에서 실행되는 쿼리들은 모두 묶여 하나로 간주된다는 것이다. 나누어서 이것은 성공 저것은 실패, 이런 결과가 발생할 수 없이 나뉘어질 수 없는 하나가 된다는 것이다.
## C - Consistency(일관성)
트랜잭션 안의 쿼리들의 결과가 데이터베이스의 일관성을 헤치지 않는 다는 것이다. 출금,입금 절차가 이루어졌을 때 돈의 총량은 같다는 것은 쿼리들의 결과가 유효하게 적용되었다는 것으로 원자성이 과정에 대한 걱정을 지웠다면 일관성은 결과에 대한 걱정을 지운다고 이해하면 될 것이다.
## I - Isolation(격리성)
격리성은 여러 레벨을 가진다.

만약 입금 출금 트랜잭션이 진행중인 도중 다른 세션에서 잔고를 읽을 때 진행중인 트랜잭션을 얼마나 격리할 것이냐를 결정하는 요소이다.

격리성이 없다면(READ UNCOMMITTED) 트랜잭션 도중 다른 세션이 잔고를 읽을 때 진행도중의 상태를 그대로 읽어올 수 있다.

대부분의 DB의 기본설정인 READ COMMITTED의 경우 트랜잭션 도중 다른 세션이 잔고를 읽는다면 트랜잭션 진행이전 상태를 읽어오게 된다.

### Non-Repeatable Read
mysql의 스토리지 엔진인 InnoDB는 기본 격리상태로 REPEATABLE READ를 가지는데 이는 READ COMMITTED보다 한단계 위의 격리레벨이다.

한 트랜잭션안에 잔고를 읽는 select문이 두 번 존재한다고 가정해보자.

이때 첫번째 select문과 두번째 select문 사이에 다른 세션이 잔고 업데이트를 일으키는 커밋을 진행했다면, READ COMMITTED 이하의 레벨에서는 첫번째와 두번째 셀렉트문의 결과가 달라진다.

하지만 mysql의 innodb는 이 또한 같음을 보장한다. 즉 트랜잭션 진행 이전의 상태를 읽는 것을 셀렉트 두번의 트랜잭션에서 동일하게 해낸다.

## D - Durability(지속성)
COMMIT이 되었다면, ROLLBACK이 되었다면 그 이후 어떤 순간에 시스템이 오류로 종료해도 커밋,롤백 결과가 변질되지 않는다는 것이다. COMMIT,ROLLBACK이 되기만하면 무조건 해당 결과는 저장된다.

